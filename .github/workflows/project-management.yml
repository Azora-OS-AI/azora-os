name: Project Management Automation

on:
  issues:
    types: [opened, labeled, unlabeled]
  pull_request:
    types: [opened, labeled, unlabeled]
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight UTC
  workflow_dispatch:

jobs:
  label-issues:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'

    steps:
    - name: Add default labels to new issues
      uses: actions/github-script@v8
      with:
        script: |
          const issue = context.payload.issue;
          const labels = ['status: ready', 'priority: medium'];

          // Add component label based on issue content
          const body = issue.body || '';
          const title = issue.title || '';

          if (body.includes('security') || title.includes('security') || body.includes('vulnerability')) {
            labels.push('type: security');
          } else if (body.includes('bug') || title.includes('bug') || body.includes('fix')) {
            labels.push('type: bug');
          } else if (body.includes('feature') || title.includes('feature') || body.includes('add')) {
            labels.push('type: feature');
          }

          // Add component labels based on content
          const components = {
            'aegis': 'component: aegis',
            'nexus': 'component: nexus',
            'covenant': 'component: covenant',
            'forge': 'component: forge',
            'mint': 'component: mint',
            'ui': 'component: ui',
            'api': 'component: api'
          };

          for (const [key, label] of Object.entries(components)) {
            if (body.includes(key) || title.includes(key)) {
              labels.push(label);
              break; // Only add one component label
            }
          }

          github.rest.issues.addLabels({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: labels
          });

  label-prs:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'opened'

    steps:
    - name: Add labels to pull requests
      uses: actions/github-script@v8
      with:
        script: |
          const pr = context.payload.pull_request;
          const labels = [];

          // Determine type based on PR title
          const title = pr.title.toLowerCase();

          if (title.includes('fix') || title.includes('bug')) {
            labels.push('type: bug');
          } else if (title.includes('feat') || title.includes('add')) {
            labels.push('type: feature');
          } else if (title.includes('docs')) {
            labels.push('type: documentation');
          } else if (title.includes('security')) {
            labels.push('type: security');
          } else if (title.includes('perf')) {
            labels.push('type: performance');
          } else if (title.includes('refactor')) {
            labels.push('type: refactoring');
          } else if (title.includes('test')) {
            labels.push('type: testing');
          } else {
            labels.push('type: enhancement');
          }

          // Add status label
          labels.push('status: ready');

          github.rest.issues.addLabels({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: labels
          });

  stale-management:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
    - name: Close stale issues
      uses: actions/stale@v9
      with:
        days-before-stale: 30
        days-before-close: 7
        stale-issue-message: |
          This issue has been automatically marked as stale because it has not had recent activity. It will be closed in 7 days if no further activity occurs.

          If this issue is still relevant, please add a comment or update it to keep it open.
        close-issue-message: 'This issue was closed because it has been inactive for 37 days.'
        exempt-issue-labels: 'priority: critical,status: blocked,help-wanted'
        operations-per-run: 30